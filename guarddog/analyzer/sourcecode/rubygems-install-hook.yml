rules:
  - id: rubygems-install-hook
    languages:
      - ruby
    message: |
      This package uses Gem::Installer hooks which execute code during gem installation.
      This is a common technique for malicious gems to run code when installed.
    metadata:
      description: Identify when a gem registers installation hooks
    patterns:
      - pattern-either:
          # Post-install hooks
          - pattern: Gem.post_install(...)
          - pattern: Gem.post_install { ... }
          - pattern: Gem.post_install do ... end
          - pattern: Gem::Installer.post_install(...)
          - pattern: Gem::Installer.post_install { ... }
          - pattern: Gem::Installer.post_install do ... end

          # Pre-install hooks
          - pattern: Gem.pre_install(...)
          - pattern: Gem.pre_install { ... }
          - pattern: Gem.pre_install do ... end
          - pattern: Gem::Installer.pre_install(...)
          - pattern: Gem::Installer.pre_install { ... }
          - pattern: Gem::Installer.pre_install do ... end

          # Post-uninstall hooks
          - pattern: Gem.post_uninstall(...)
          - pattern: Gem.post_uninstall { ... }
          - pattern: Gem.post_uninstall do ... end

          # Pre-uninstall hooks
          - pattern: Gem.pre_uninstall(...)
          - pattern: Gem.pre_uninstall { ... }
          - pattern: Gem.pre_uninstall do ... end

          # Extension building (can run arbitrary code)
          - pattern: |
              Gem::Specification.new do |$S|
                ...
                $S.extensions = ...
                ...
              end
    severity: WARNING
