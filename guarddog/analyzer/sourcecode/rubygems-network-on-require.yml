rules:
  - id: rubygems-network-on-require
    languages:
      - ruby
    message: |
      This package makes network requests at the top level, which means it runs
      when the gem is required. Malicious gems often use this to phone home or
      download additional payloads.
    metadata:
      description: Identify when a gem makes network requests when required
    patterns:
      - pattern-either:
          # Net::HTTP at top level
          - pattern: |
              require 'net/http'
              ...
              Net::HTTP.$METHOD(...)
          - pattern: |
              require "net/http"
              ...
              Net::HTTP.$METHOD(...)

          # open-uri at top level
          - pattern: |
              require 'open-uri'
              ...
              URI.open(...)
          - pattern: |
              require "open-uri"
              ...
              URI.open(...)
          - pattern: |
              require 'open-uri'
              ...
              open(...)
          - pattern: |
              require "open-uri"
              ...
              open(...)

          # HTTParty at top level
          - pattern: |
              require 'httparty'
              ...
              HTTParty.$METHOD(...)
          - pattern: |
              require "httparty"
              ...
              HTTParty.$METHOD(...)

          # Faraday at top level
          - pattern: |
              require 'faraday'
              ...
              Faraday.$METHOD(...)
          - pattern: |
              require "faraday"
              ...
              Faraday.$METHOD(...)

          # Socket connections at top level
          - pattern: |
              require 'socket'
              ...
              TCPSocket.new(...)
          - pattern: |
              require "socket"
              ...
              TCPSocket.new(...)
          - pattern: |
              require 'socket'
              ...
              TCPSocket.open(...)
          - pattern: |
              require "socket"
              ...
              TCPSocket.open(...)
    severity: WARNING
