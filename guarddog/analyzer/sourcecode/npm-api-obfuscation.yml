rules:
  - id: npm-api-obfuscation
    languages:
      - javascript
    message: This package uses obfuscated API calls that may evade static analysis detection
    metadata:
      description: Identify obfuscated API calls using alternative JS syntax patterns
    severity: WARNING
    patterns:
      - pattern-either:
        # Covered cases:
        # 1) module["function"]()
        # 2) Reflect.get(module, "function")()
        # 3) Object.getOwnPropertyDescriptor(module, "function").value()
        # 4) module[Object.getOwnPropertyNames(module).find(name => name === "function")]()
        # 5) module[Object.keys(module).find(name => name === "function")]()
        # 6) Object.entries(module).find(([name, value]) => name === "function")[1]()
        # 7) Object.entries(module).filter(([k]) => k === 'function')[0][1]()
        # Each of these can also use .call(), .apply(), .bind() variants as well:
        # e.g., module["function"].call({}, ...), module["function"].apply({}, [...]), module["function"].bind({})(...)
        - pattern: $MODULE[$FUNCTION]($...ARGS)
        - pattern: $MODULE[$FUNCTION].call($...ARGS)
        - pattern: $MODULE[$FUNCTION].apply($...ARGS)
        - pattern: $MODULE[$FUNCTION].bind($...ARGS)()
        - pattern: Reflect.get($MODULE, $FUNCTION)($...ARGS)
        - pattern: Reflect.get($MODULE, $FUNCTION).call($...ARGS)
        - pattern: Reflect.get($MODULE, $FUNCTION).apply($...ARGS)
        - pattern: Reflect.get($MODULE, $FUNCTION).bind($...ARGS)()
        - pattern: Object.getOwnPropertyDescriptor($MODULE, $FUNCTION).value($...ARGS)
        - pattern: Object.getOwnPropertyDescriptor($MODULE, $FUNCTION).value.call($...ARGS)
        - pattern: Object.getOwnPropertyDescriptor($MODULE, $FUNCTION).value.apply($...ARGS)
        - pattern: Object.getOwnPropertyDescriptor($MODULE, $FUNCTION).value.bind($...ARGS)()
        - pattern: $MODULE[Object.getOwnPropertyNames($MODULE).find($VAR => $VAR === $FUNCTION)]($...ARGS)
        - pattern: $MODULE[Object.getOwnPropertyNames($MODULE).find($VAR => $VAR === $FUNCTION)].call($...ARGS)
        - pattern: $MODULE[Object.getOwnPropertyNames($MODULE).find($VAR => $VAR === $FUNCTION)].apply($...ARGS)
        - pattern: $MODULE[Object.getOwnPropertyNames($MODULE).find($VAR => $VAR === $FUNCTION)].bind($...ARGS)()
        - pattern: $MODULE[Object.keys($MODULE).find($VAR => $VAR === $FUNCTION)]($...ARGS)
        - pattern: $MODULE[Object.keys($MODULE).find($VAR => $VAR === $FUNCTION)].call($...ARGS)
        - pattern: $MODULE[Object.keys($MODULE).find($VAR => $VAR === $FUNCTION)].apply($...ARGS)
        - pattern: $MODULE[Object.keys($MODULE).find($VAR => $VAR === $FUNCTION)].bind($...ARGS)()
        - pattern: Object.entries($MODULE).find(([$VAR, $VALUE]) => $VAR === $FUNCTION)[1]($...ARGS)
        - pattern: Object.entries($MODULE).find(([$VAR, $VALUE]) => $VAR === $FUNCTION)[1].call($...ARGS)
        - pattern: Object.entries($MODULE).find(([$VAR, $VALUE]) => $VAR === $FUNCTION)[1].apply($...ARGS)
        - pattern: Object.entries($MODULE).find(([$VAR, $VALUE]) => $VAR === $FUNCTION)[1].bind($...ARGS)()
        - pattern: Object.entries($MODULE).filter(([$VAR]) => $VAR === $FUNCTION)[0][1]($...ARGS)
        - pattern: Object.entries($MODULE).filter(([$VAR]) => $VAR === $FUNCTION)[0][1].call($...ARGS)
        - pattern: Object.entries($MODULE).filter(([$VAR]) => $VAR === $FUNCTION)[0][1].apply($...ARGS)
        - pattern: Object.entries($MODULE).filter(([$VAR]) => $VAR === $FUNCTION)[0][1].bind($...ARGS)()
      - metavariable-regex:
          metavariable: $MODULE
          regex: "^[A-Za-z_][A-Za-z0-9_]*$"