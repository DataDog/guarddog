rules:
  - id: code-execution
    languages:
      - python
    message: Code execution found in setup.py, could potentially execute unwanted code.
    pattern-either:
      # Hardcoded string in exec function
      - pattern: exec("...", ...)
      - pattern: exec("...". ...)
      - pattern: exec("..." + ...)

      - pattern: execfile(...)
      - pattern: subprocess.getoutput(...)
      - pattern: subprocess.call(...)
      - pattern: subprocess.check_output(...)
      - pattern: subprocess.run(...)
      - pattern: command.run(...)

      # Avoid legitimate eval case for version.py
      - patterns:
        - pattern: eval($ARG1. ...)
        - pattern-not-inside: |
            if $ARG1.startswith($STR):
              ...

      # Avoid legitimate Popen case for running git commands
      - patterns:
        - pattern-either:
          - pattern: os.Popen($ARG1, ...)
          - pattern: os.popen($ARG1, ...)
          - pattern: Popen($ARG1, ...)
          - pattern: popen($ARG1, ...)
        - metavariable-pattern:
            metavariable: $ARG1
            patterns:
              - pattern-not: (["git"] + ...)
      
      # Avoid legitimate os.system case used for setup purposes
      - patterns:
        - pattern: os.system($STR)
        - metavariable-pattern:
            metavariable: $STR
            patterns:
              - pattern-not-regex: (setup.py)|(twine upload)|(setup.py sdist)|(git \w+)
    paths:
      include:
        - "*/setup.py"
        - semgrep_tests/code-execution.py # Need to run on test file
    severity: WARNING


# - metavariable-pattern:
#     metavariable: $VERSION
#     patterns:
#       - pattern-not-regex: (.*/?[__]?version.py[__]?)



